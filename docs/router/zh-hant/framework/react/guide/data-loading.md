---
source-updated-at: '2025-02-22T09:47:51.000Z'
translation-updated-at: '2025-05-08T20:21:59.420Z'
id: data-loading
title: è³‡æ–™è¼‰å…¥
---

# è³‡æ–™è¼‰å…¥ (Data Loading)

è³‡æ–™è¼‰å…¥æ˜¯ç¶²é æ‡‰ç”¨ç¨‹å¼çš„å¸¸è¦‹éœ€æ±‚ï¼Œä¸”èˆ‡è·¯ç”±å¯†åˆ‡ç›¸é—œã€‚åœ¨è¼‰å…¥æ‡‰ç”¨ç¨‹å¼é é¢æ™‚ï¼Œæœ€ç†æƒ³çš„ç‹€æ³æ˜¯æ‰€æœ‰é é¢çš„éåŒæ­¥éœ€æ±‚éƒ½èƒ½ç›¡æ—©ä¸¦è¡Œåœ°ç²å–èˆ‡æ»¿è¶³ã€‚è·¯ç”±æ˜¯å”èª¿é€™äº›éåŒæ­¥ä¾è³´çš„æœ€ä½³ä½ç½®ï¼Œå› ç‚ºå®ƒé€šå¸¸æ˜¯æ‡‰ç”¨ç¨‹å¼ä¸­å”¯ä¸€èƒ½åœ¨å…§å®¹æ¸²æŸ“å‰å°±çŸ¥é“ç”¨æˆ¶å°‡å‰å¾€ä½•è™•çš„åœ°æ–¹ã€‚

æ‚¨å¯èƒ½ç†Ÿæ‚‰ Next.js çš„ `getServerSideProps` æˆ– Remix/React-Router çš„ `loader`ã€‚TanStack Router å…·æœ‰é¡ä¼¼çš„åŠŸèƒ½ï¼Œå¯ä»¥ä¸¦è¡Œåœ°é è¼‰/è¼‰å…¥æ¯å€‹è·¯ç”±çš„è³‡æºï¼Œè®“å®ƒèƒ½åœ¨é€é suspense ç²å–è³‡æ–™æ™‚ç›¡å¿«æ¸²æŸ“ã€‚

é™¤äº†é€™äº›è·¯ç”±å™¨çš„åŸºæœ¬åŠŸèƒ½å¤–ï¼ŒTanStack Router æ›´é€²ä¸€æ­¥æä¾›äº†**å…§å»ºçš„ SWR å¿«å– (SWR Caching)**ï¼Œé€™æ˜¯ä¸€å€‹é•·æœŸè¨˜æ†¶é«”å¿«å–å±¤ï¼Œç”¨æ–¼è·¯ç”±è¼‰å…¥å™¨ã€‚é€™æ„å‘³è‘—æ‚¨å¯ä»¥ä½¿ç”¨ TanStack Router é è¼‰è·¯ç”±è³‡æ–™ä½¿å…¶ç¬é–“è¼‰å…¥ï¼Œæˆ–æš«æ™‚å¿«å­˜å–è¨ªéçš„è·¯ç”±è³‡æ–™ä»¥ä¾›å¾ŒçºŒä½¿ç”¨ã€‚

## è·¯ç”±è¼‰å…¥ç”Ÿå‘½é€±æœŸ (Route loading lifecycle)

æ¯æ¬¡æª¢æ¸¬åˆ° URL/æ­·å²è¨˜éŒ„æ›´æ–°æ™‚ï¼Œè·¯ç”±å™¨æœƒåŸ·è¡Œä»¥ä¸‹é †åºï¼š

- è·¯ç”±åŒ¹é… (ç”±ä¸Šè‡³ä¸‹)
  - `route.params.parse`
  - `route.validateSearch`
- è·¯ç”±é è¼‰ (åºåˆ—åŒ–)
  - `route.beforeLoad`
  - `route.onError`
    - `route.errorComponent` / `parentRoute.errorComponent` / `router.defaultErrorComponent`
- è·¯ç”±è¼‰å…¥ (ä¸¦è¡Œ)
  - `route.component.preload?`
  - `route.loader`
    - `route.pendingComponent` (é¸ç”¨)
    - `route.component`
  - `route.onError`
    - `route.errorComponent` / `parentRoute.errorComponent` / `router.defaultErrorComponent`

## ä½¿ç”¨è·¯ç”±å™¨å¿«å–èˆ‡å¦ï¼Ÿ (To Router Cache or not to Router Cache?)

TanStack çš„è·¯ç”±å¿«å–å¾ˆå¯èƒ½é©åˆå¤§å¤šæ•¸ä¸­å°å‹æ‡‰ç”¨ç¨‹å¼ï¼Œä½†äº†è§£ä½¿ç”¨å®ƒèˆ‡æ›´å¼·å¤§çš„å¿«å–è§£æ±ºæ–¹æ¡ˆï¼ˆå¦‚ TanStack Queryï¼‰ä¹‹é–“çš„æ¬Šè¡¡å¾ˆé‡è¦ï¼š

TanStack Router å¿«å–çš„å„ªé»ï¼š

- å…§å»ºã€æ˜“æ–¼ä½¿ç”¨ï¼Œç„¡éœ€é¡å¤–ä¾è³´
- è™•ç†å»é‡è¤‡ã€é è¼‰ã€è¼‰å…¥ã€éæœŸé‡æ–°é©—è­‰ (stale-while-revalidate)ã€åŸºæ–¼æ¯å€‹è·¯ç”±çš„èƒŒæ™¯é‡æ–°ç²å–
- ç²—ç•¥å¤±æ•ˆ (ä¸€æ¬¡å¤±æ•ˆæ‰€æœ‰è·¯ç”±å’Œå¿«å–)
- è‡ªå‹•åƒåœ¾å›æ”¶
- é©ç”¨æ–¼è·¯ç”±é–“å…±äº«è³‡æ–™è¼ƒå°‘çš„æ‡‰ç”¨ç¨‹å¼
- å° SSRã€Œé–‹ç®±å³ç”¨ã€

TanStack Router å¿«å–çš„ç¼ºé»ï¼š

- æ²’æœ‰æŒä¹…åŒ–é©é…å™¨/æ¨¡å‹
- è·¯ç”±é–“æ²’æœ‰å…±äº«å¿«å–/å»é‡è¤‡
- æ²’æœ‰å…§å»ºçš„è®Šæ›´ APIï¼ˆè¨±å¤šç¯„ä¾‹ä¸­æä¾›äº†åŸºæœ¬çš„ `useMutation` é‰¤å­ï¼Œå¯èƒ½è¶³ä»¥æ‡‰ä»˜è¨±å¤šä½¿ç”¨æƒ…å¢ƒï¼‰
- æ²’æœ‰å…§å»ºçš„å¿«å–å±¤ç´šæ¨‚è§€æ›´æ–° APIï¼ˆæ‚¨ä»å¯ä»¥ä½¿ç”¨åƒ `useMutation` é‰¤å­çš„çŸ­æš«ç‹€æ…‹åœ¨å…ƒä»¶å±¤ç´šå¯¦ç¾ï¼‰

> [!TIP]
> å¦‚æœæ‚¨å·²ç¢ºå®šéœ€è¦ä½¿ç”¨æ›´å¼·å¤§çš„å·¥å…·å¦‚ TanStack Queryï¼Œè«‹ç›´æ¥è·³è‡³[å¤–éƒ¨è³‡æ–™è¼‰å…¥](./external-data-loading.md)æŒ‡å—ã€‚

## ä½¿ç”¨è·¯ç”±å™¨å¿«å– (Using the Router Cache)

è·¯ç”±å™¨å¿«å–æ˜¯å…§å»ºçš„ï¼Œåªéœ€å¾ä»»ä½•è·¯ç”±çš„ `loader` å‡½æ•¸è¿”å›è³‡æ–™å³å¯ä½¿ç”¨ã€‚è®“æˆ‘å€‘å­¸ç¿’å¦‚ä½•ä½¿ç”¨ï¼

## è·¯ç”± `loader` (Route `loader`s)

è·¯ç”± `loader` å‡½æ•¸åœ¨è·¯ç”±åŒ¹é…è¼‰å…¥æ™‚è¢«å‘¼å«ã€‚å®ƒå€‘æ¥æ”¶ä¸€å€‹åƒæ•¸ï¼Œé€™æ˜¯ä¸€å€‹åŒ…å«è¨±å¤šæœ‰ç”¨å±¬æ€§çš„ç‰©ä»¶ã€‚æˆ‘å€‘ç¨å¾Œæœƒè©³ç´°ä»‹ç´¹é€™äº›å±¬æ€§ï¼Œä½†é¦–å…ˆè®“æˆ‘å€‘çœ‹ä¸€å€‹è·¯ç”± `loader` å‡½æ•¸çš„ç¯„ä¾‹ï¼š

```tsx
// routes/posts.tsx
export const Route = createFileRoute('/posts')({
  loader: () => fetchPosts(),
})
```

## `loader` åƒæ•¸ (`loader` Parameters)

`loader` å‡½æ•¸æ¥æ”¶ä¸€å€‹åŒ…å«ä»¥ä¸‹å±¬æ€§çš„ç‰©ä»¶ï¼š

- `abortController` - è·¯ç”±çš„ abortControllerã€‚ç•¶è·¯ç”±å¸è¼‰æˆ–ç•¶å‰ `loader` å‡½æ•¸èª¿ç”¨ä¸å†ç›¸é—œæ™‚ï¼Œå…¶ signal æœƒè¢«å–æ¶ˆã€‚
- `cause` - ç•¶å‰è·¯ç”±åŒ¹é…çš„åŸå› ï¼Œå¯èƒ½æ˜¯ `enter` æˆ– `stay`ã€‚
- `context` - è·¯ç”±çš„ä¸Šä¸‹æ–‡ç‰©ä»¶ï¼Œæ˜¯ä»¥ä¸‹å…§å®¹çš„åˆä½µï¼š
  - çˆ¶è·¯ç”±ä¸Šä¸‹æ–‡
  - ç”± `beforeLoad` é¸é …æä¾›çš„æ­¤è·¯ç”±ä¸Šä¸‹æ–‡
- `deps` - ç”± `Route.loaderDeps` å‡½æ•¸è¿”å›çš„ç‰©ä»¶å€¼ã€‚å¦‚æœæœªå®šç¾© `Route.loaderDeps`ï¼Œå‰‡æä¾›ç©ºç‰©ä»¶ã€‚
- `location` - ç•¶å‰ä½ç½®
- `params` - è·¯ç”±çš„è·¯å¾‘åƒæ•¸
- `parentMatchPromise` - `Promise<RouteMatch>`ï¼ˆæ ¹è·¯ç”±ç‚º `undefined`ï¼‰
- `preload` - å¸ƒæ—å€¼ï¼Œç•¶è·¯ç”±è¢«é è¼‰è€Œéè¼‰å…¥æ™‚ç‚º `true`
- `route` - è·¯ç”±æœ¬èº«

ä½¿ç”¨é€™äº›åƒæ•¸ï¼Œæˆ‘å€‘å¯ä»¥åšå¾ˆå¤šé…·ç‚«çš„äº‹æƒ…ï¼Œä½†é¦–å…ˆè®“æˆ‘å€‘çœ‹çœ‹å¦‚ä½•æ§åˆ¶å®ƒä»¥åŠä½•æ™‚å‘¼å« `loader` å‡½æ•¸ã€‚

## å¾ `loader` æ¶ˆè²»è³‡æ–™ (Consuming data from `loader`s)

è¦å¾ `loader` æ¶ˆè²»è³‡æ–™ï¼Œè«‹ä½¿ç”¨ Route ç‰©ä»¶ä¸Šå®šç¾©çš„ `useLoaderData` é‰¤å­ã€‚

```tsx
const posts = Route.useLoaderData()
```

å¦‚æœç„¡æ³•ç›´æ¥å­˜å–æ‚¨çš„è·¯ç”±ç‰©ä»¶ï¼ˆä¾‹å¦‚æ‚¨ä½æ–¼ç•¶å‰è·¯ç”±çš„å…ƒä»¶æ¨¹æ·±è™•ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ `getRouteApi` å­˜å–ç›¸åŒçš„é‰¤å­ï¼ˆä»¥åŠ Route ç‰©ä»¶ä¸Šçš„å…¶ä»–é‰¤å­ï¼‰ã€‚é€™æ‡‰è©²æ¯”ç›´æ¥å°å…¥ Route ç‰©ä»¶æ›´å—é’çï¼Œå› ç‚ºå¾Œè€…å¯èƒ½æœƒé€ æˆå¾ªç’°ä¾è³´ã€‚

```tsx
import { getRouteApi } from '@tanstack/react-router'

// åœ¨æ‚¨çš„å…ƒä»¶ä¸­

const routeApi = getRouteApi('/posts')
const data = routeApi.useLoaderData()
```

## åŸºæ–¼ä¾è³´çš„éæœŸé‡æ–°é©—è­‰å¿«å– (Dependency-based Stale-While-Revalidate Caching)

TanStack Router ç‚ºè·¯ç”±è¼‰å…¥å™¨æä¾›äº†ä¸€å€‹å…§å»ºçš„éæœŸé‡æ–°é©—è­‰ (Stale-While-Revalidate) å¿«å–å±¤ï¼Œå…¶éµå€¼åŸºæ–¼è·¯ç”±çš„ä¾è³´ï¼š

- è·¯ç”±çš„å®Œæ•´è§£æè·¯å¾‘åç¨±
  - ä¾‹å¦‚ `/posts/1` èˆ‡ `/posts/2`
- ç”± `loaderDeps` é¸é …æä¾›çš„ä»»ä½•é¡å¤–ä¾è³´
  - ä¾‹å¦‚ `loaderDeps: ({ search: { pageIndex, pageSize } }) => ({ pageIndex, pageSize })`

ä½¿ç”¨é€™äº›ä¾è³´ä½œç‚ºéµå€¼ï¼ŒTanStack Router æœƒå¿«å–å¾è·¯ç”±çš„ `loader` å‡½æ•¸è¿”å›çš„è³‡æ–™ï¼Œä¸¦ç”¨å®ƒä¾†æ»¿è¶³å°ç›¸åŒè·¯ç”±åŒ¹é…çš„å¾ŒçºŒè«‹æ±‚ã€‚é€™æ„å‘³è‘—å¦‚æœè·¯ç”±çš„è³‡æ–™å·²åœ¨å¿«å–ä¸­ï¼Œå®ƒæœƒç«‹å³è¿”å›ï¼Œç„¶å¾Œ**å¯èƒ½**åœ¨èƒŒæ™¯é‡æ–°ç²å–ï¼Œå…·é«”å–æ±ºæ–¼è³‡æ–™çš„ã€Œæ–°é®®åº¦ã€ã€‚

### éµå€¼é¸é … (Key options)

ç‚ºäº†æ§åˆ¶è·¯ç”±ä¾è³´å’Œã€Œæ–°é®®åº¦ã€ï¼ŒTanStack Router æä¾›äº†å¤§é‡é¸é …ä¾†æ§åˆ¶è·¯ç”±è¼‰å…¥å™¨çš„éµå€¼å’Œå¿«å–è¡Œç‚ºã€‚è®“æˆ‘å€‘æŒ‰æ‚¨æœ€å¯èƒ½ä½¿ç”¨çš„é †åºä¾†çœ‹çœ‹å®ƒå€‘ï¼š

- `routeOptions.loaderDeps`
  - ä¸€å€‹å‡½æ•¸ï¼Œæä¾›è·¯ç”±å™¨çš„æœå°‹åƒæ•¸ä¸¦è¿”å›ä¸€å€‹ä¾è³´ç‰©ä»¶ä¾› `loader` å‡½æ•¸ä½¿ç”¨ã€‚ç•¶é€™äº›ä¾è³´åœ¨å°èˆªé–“è®ŠåŒ–æ™‚ï¼Œç„¡è«– `staleTime` å¦‚ä½•ï¼Œéƒ½æœƒå°è‡´è·¯ç”±é‡æ–°è¼‰å…¥ã€‚ä¾è³´ä½¿ç”¨æ·±åº¦ç›¸ç­‰æª¢æŸ¥é€²è¡Œæ¯”è¼ƒã€‚
- `routeOptions.staleTime`
- `routerOptions.defaultStaleTime`
  - å˜—è©¦è¼‰å…¥æ™‚ï¼Œè·¯ç”±è³‡æ–™è¢«è¦–ç‚ºæ–°é®®çš„æ¯«ç§’æ•¸ã€‚
- `routeOptions.preloadStaleTime`
- `routerOptions.defaultPreloadStaleTime`
  - å˜—è©¦é è¼‰æ™‚ï¼Œè·¯ç”±è³‡æ–™è¢«è¦–ç‚ºæ–°é®®çš„æ¯«ç§’æ•¸ã€‚
- `routeOptions.gcTime`
- `routerOptions.defaultGcTime`
  - è·¯ç”±è³‡æ–™åœ¨å¿«å–ä¸­ä¿ç•™çš„æ¯«ç§’æ•¸ï¼Œä¹‹å¾Œæœƒè¢«åƒåœ¾å›æ”¶ã€‚
- `routeOptions.shouldReload`
  - ä¸€å€‹å‡½æ•¸ï¼Œæ¥æ”¶èˆ‡ `beforeLoad` å’Œ `loaderContext` ç›¸åŒçš„åƒæ•¸ï¼Œä¸¦è¿”å›ä¸€å€‹å¸ƒæ—å€¼ï¼ŒæŒ‡ç¤ºè·¯ç”±æ˜¯å¦æ‡‰é‡æ–°è¼‰å…¥ã€‚é€™æä¾›äº†å°è·¯ç”±ä½•æ™‚æ‡‰é‡æ–°è¼‰å…¥çš„å¦ä¸€å±¤æ§åˆ¶ï¼Œè¶…è¶Šäº† `staleTime` å’Œ `loaderDeps`ï¼Œå¯ç”¨æ–¼å¯¦ç¾é¡ä¼¼ Remix çš„ `shouldLoad` é¸é …çš„æ¨¡å¼ã€‚

### âš ï¸ ä¸€äº›é‡è¦çš„é è¨­å€¼ (Some Important Defaults)

- é è¨­æƒ…æ³ä¸‹ï¼Œ`staleTime` è¨­ç‚º `0`ï¼Œæ„å‘³è‘—è·¯ç”±çš„è³‡æ–™ç¸½æ˜¯æœƒè¢«è¦–ç‚ºéæœŸï¼Œä¸¦ä¸”åœ¨è·¯ç”±é‡æ–°åŒ¹é…æ™‚ç¸½æœƒåœ¨èƒŒæ™¯é‡æ–°è¼‰å…¥ã€‚
- é è¨­æƒ…æ³ä¸‹ï¼Œå…ˆå‰é è¼‰çš„è·¯ç”±è¢«è¦–ç‚ºæ–°é®®**30 ç§’**ã€‚é€™æ„å‘³è‘—å¦‚æœä¸€å€‹è·¯ç”±è¢«é è¼‰ï¼Œç„¶å¾Œåœ¨ 30 ç§’å…§å†æ¬¡é è¼‰ï¼Œç¬¬äºŒæ¬¡é è¼‰å°‡è¢«å¿½ç•¥ã€‚é€™é˜²æ­¢äº†ä¸å¿…è¦çš„é è¼‰éæ–¼é »ç¹åœ°ç™¼ç”Ÿã€‚**ç•¶è·¯ç”±æ­£å¸¸è¼‰å…¥æ™‚ï¼Œä½¿ç”¨æ¨™æº–çš„ `staleTime`ã€‚**
- é è¨­æƒ…æ³ä¸‹ï¼Œ`gcTime` è¨­ç‚º**30 åˆ†é˜**ï¼Œæ„å‘³è‘—ä»»ä½• 30 åˆ†é˜å…§æœªè¢«å­˜å–çš„è·¯ç”±è³‡æ–™å°‡è¢«åƒåœ¾å›æ”¶ä¸¦å¾å¿«å–ä¸­ç§»é™¤ã€‚
- `router.invalidate()` æœƒå¼·åˆ¶æ‰€æœ‰æ´»å‹•è·¯ç”±ç«‹å³é‡æ–°è¼‰å…¥å…¶è¼‰å…¥å™¨ï¼Œä¸¦å°‡æ¯å€‹å¿«å–è·¯ç”±çš„è³‡æ–™æ¨™è¨˜ç‚ºéæœŸã€‚

### ä½¿ç”¨ `loaderDeps` å­˜å–æœå°‹åƒæ•¸ (Using `loaderDeps` to access search params)

æƒ³åƒä¸€å€‹ `/posts` è·¯ç”±é€éæœå°‹åƒæ•¸ `offset` å’Œ `limit` æ”¯æ´åˆ†é ã€‚ç‚ºäº†è®“å¿«å–èƒ½å”¯ä¸€å„²å­˜é€™äº›è³‡æ–™ï¼Œæˆ‘å€‘éœ€è¦é€é `loaderDeps` å‡½æ•¸å­˜å–é€™äº›æœå°‹åƒæ•¸ã€‚é€éæ˜ç¢ºæ¨™è­˜å®ƒå€‘ï¼Œæ¯å€‹å…·æœ‰ä¸åŒ `offset` å’Œ `limit` çš„ `/posts` è·¯ç”±åŒ¹é…ä¸æœƒæ··æ·†ï¼

ä¸€æ—¦æˆ‘å€‘æœ‰äº†é€™äº›ä¾è³´ï¼Œè·¯ç”±å°‡åœ¨ä¾è³´è®ŠåŒ–æ™‚ç¸½æ˜¯é‡æ–°è¼‰å…¥ã€‚

```tsx
// /routes/posts.tsx
export const Route = createFileRoute('/posts')({
  loaderDeps: ({ search: { offset, limit } }) => ({ offset, limit }),
  loader: ({ deps: { offset, limit } }) =>
    fetchPosts({
      offset,
      limit,
    }),
})
```

### ä½¿ç”¨ `staleTime` æ§åˆ¶è³‡æ–™è¢«è¦–ç‚ºæ–°é®®çš„æ™‚é–“ (Using `staleTime` to control how long data is considered fresh)

é è¨­æƒ…æ³ä¸‹ï¼Œå°èˆªçš„ `staleTime` è¨­ç‚º `0` æ¯«ç§’ï¼ˆé è¼‰ç‚º 30 ç§’ï¼‰ï¼Œé€™æ„å‘³è‘—è·¯ç”±çš„è³‡æ–™ç¸½æ˜¯æœƒè¢«è¦–ç‚ºéæœŸï¼Œä¸¦ä¸”åœ¨è·¯ç”±åŒ¹é…å’Œå°èˆªåˆ°æ™‚ç¸½æœƒåœ¨èƒŒæ™¯é‡æ–°è¼‰å…¥ã€‚

**é€™å°å¤§å¤šæ•¸ä½¿ç”¨æƒ…å¢ƒä¾†èªªæ˜¯å€‹å¥½é è¨­ï¼Œä½†æ‚¨å¯èƒ½æœƒç™¼ç¾æŸäº›è·¯ç”±è³‡æ–™æ›´éœæ…‹æˆ–å¯èƒ½è¼‰å…¥æˆæœ¬è¼ƒé«˜ã€‚**åœ¨é€™äº›æƒ…æ³ä¸‹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `staleTime` é¸é …ä¾†æ§åˆ¶è·¯ç”±è³‡æ–™å°å°èˆªä¿æŒæ–°é®®çš„æ™‚é–“ã€‚è®“æˆ‘å€‘çœ‹ä¸€å€‹ç¯„ä¾‹ï¼š

```tsx
// /routes/posts.tsx
export const Route = createFileRoute('/posts')({
  loader: () => fetchPosts(),
  // å°‡è·¯ç”±è³‡æ–™è¦–ç‚ºæ–°é®® 10 ç§’
  staleTime: 10_000,
})
```

é€éå°‡ `10_000` å‚³éçµ¦ `staleTime` é¸é …ï¼Œæˆ‘å€‘å‘Šè¨´è·¯ç”±å™¨å°‡è·¯ç”±è³‡æ–™è¦–ç‚ºæ–°é®® 10 ç§’ã€‚é€™æ„å‘³è‘—å¦‚æœä½¿ç”¨è€…åœ¨æœ€å¾Œä¸€æ¬¡è¼‰å…¥çµæœçš„ 10 ç§’å…§å¾ `/about` å°èˆªåˆ° `/posts`ï¼Œè·¯ç”±çš„è³‡æ–™ä¸æœƒé‡æ–°è¼‰å…¥ã€‚å¦‚æœä½¿ç”¨è€…åœ¨ 10 ç§’å¾Œå¾ `/about` å°èˆªåˆ° `/posts`ï¼Œè·¯ç”±çš„è³‡æ–™å°‡åœ¨**èƒŒæ™¯**é‡æ–°è¼‰å…¥ã€‚

## é—œé–‰éæœŸé‡æ–°é©—è­‰å¿«å– (Turning off stale-while-revalidate caching)

è¦ç‚ºè·¯ç”±åœç”¨éæœŸé‡æ–°é©—è­‰å¿«å–ï¼Œè«‹å°‡ `staleTime` é¸é …è¨­ç‚º `Infinity`ï¼š

```tsx
// /routes/posts.tsx
export const Route = createFileRoute('/posts')({
  loader: () => fetchPosts(),
  staleTime: Infinity,
})
```

æ‚¨ç”šè‡³å¯ä»¥é€éåœ¨è·¯ç”±å™¨ä¸Šè¨­å®š `defaultStaleTime` é¸é …ä¾†ç‚ºæ‰€æœ‰è·¯ç”±é—œé–‰æ­¤åŠŸèƒ½ï¼š

```tsx
const router = createRouter({
  routeTree,
  defaultStaleTime: Infinity,
})
```

## ä½¿ç”¨ `shouldReload` å’Œ `gcTime` é¸æ“‡é€€å‡ºå¿«å– (Using `shouldReload` and `gcTime` to opt-out of caching)

é¡ä¼¼æ–¼ Remix çš„é è¨­åŠŸèƒ½ï¼Œæ‚¨å¯èƒ½å¸Œæœ›é…ç½®è·¯ç”±åƒ…åœ¨é€²å…¥æˆ–é—œéµè¼‰å…¥å™¨ä¾è³´è®ŠåŒ–æ™‚è¼‰å…¥ã€‚æ‚¨å¯ä»¥é€éçµåˆä½¿ç”¨ `gcTime` é¸é …å’Œ `shouldReload` é¸é …ä¾†å¯¦ç¾é€™ä¸€é»ï¼Œå¾Œè€…æ¥å—ä¸€å€‹å¸ƒæ—å€¼æˆ–ä¸€å€‹å‡½æ•¸ï¼Œè©²å‡½æ•¸æ¥æ”¶èˆ‡ `beforeLoad` å’Œ `loaderContext` ç›¸åŒçš„åƒæ•¸ï¼Œä¸¦è¿”å›ä¸€å€‹å¸ƒæ—å€¼ï¼ŒæŒ‡ç¤ºè·¯ç”±æ˜¯å¦æ‡‰é‡æ–°è¼‰å…¥ã€‚

```tsx
// /routes/posts.tsx
export const Route = createFileRoute('/posts')({
  loaderDeps: ({ search: { offset, limit } }) => ({ offset, limit }),
  loader: ({ deps }) => fetchPosts(deps),
  // åœ¨å¸è¼‰å¾Œä¸å¿«å–æ­¤è·¯ç”±çš„è³‡æ–™
  gcTime: 0,
  // åƒ…åœ¨ä½¿ç”¨è€…å°èˆªåˆ°æˆ–ä¾è³´è®ŠåŒ–æ™‚é‡æ–°è¼‰å…¥è·¯ç”±
  shouldReload: false,
})
```

### é¸æ“‡é€€å‡ºå¿«å–åŒæ™‚ä»é è¼‰ (Opting out of caching while still preloading)

å³ä½¿æ‚¨é¸æ“‡é€€å‡ºè·¯ç”±è³‡æ–™çš„çŸ­æœŸå¿«å–ï¼Œæ‚¨ä»ç„¶å¯ä»¥ç²å¾—é è¼‰çš„å¥½è™•ï¼ä½¿ç”¨ä¸Šè¿°é…ç½®ï¼Œé è¼‰ä»æœƒã€Œé–‹ç®±å³ç”¨ã€ä¸¦ä½¿ç”¨é è¨­çš„ `preloadGcTime`ã€‚é€™æ„å‘³è‘—å¦‚æœä¸€å€‹è·¯ç”±è¢«é è¼‰ï¼Œç„¶å¾Œå°èˆªåˆ°ï¼Œè·¯ç”±çš„è³‡æ–™å°‡è¢«è¦–ç‚ºæ–°é®®ä¸”ä¸æœƒé‡æ–°è¼‰å…¥ã€‚

è¦é¸æ“‡é€€å‡ºé è¼‰ï¼Œè«‹ä¸è¦é€é `routerOptions.defaultPreload` æˆ– `routeOptions.preload` é¸é …é–‹å•Ÿå®ƒã€‚

## å°‡æ‰€æœ‰è¼‰å…¥å™¨äº‹ä»¶å‚³éåˆ°å¤–éƒ¨å¿«å– (Passing all loader events to an external cache)

æˆ‘å€‘åœ¨[å¤–éƒ¨è³‡æ–™è¼‰å…¥](./external-data-loading.md)é é¢åˆ†è§£äº†é€™å€‹ä½¿ç”¨æ¡ˆä¾‹ï¼Œä½†å¦‚æœæ‚¨æƒ³ä½¿ç”¨åƒ TanStack Query é€™æ¨£çš„å¤–éƒ¨å¿«å–ï¼Œå¯ä»¥é€éå°‡æ‰€æœ‰è¼‰å…¥å™¨äº‹ä»¶å‚³éçµ¦æ‚¨çš„å¤–éƒ¨å¿«å–ä¾†å¯¦ç¾ã€‚åªè¦æ‚¨ä½¿ç”¨é è¨­å€¼ï¼Œå”¯ä¸€éœ€è¦åšçš„æ›´æ”¹æ˜¯å°‡è·¯ç”±å™¨ä¸Šçš„ `defaultPreloadStaleTime` é¸é …è¨­ç‚º `0`ï¼š

```tsx
const router = createRouter({
  routeTree,
  defaultPreloadStaleTime: 0,
})
```

é€™å°‡ç¢ºä¿æ¯å€‹é è¼‰ã€è¼‰å…¥å’Œé‡æ–°è¼‰å…¥äº‹ä»¶éƒ½æœƒè§¸ç™¼æ‚¨çš„ `loader` å‡½æ•¸ï¼Œç„¶å¾Œå¯ä»¥ç”±æ‚¨çš„å¤–éƒ¨å¿«å–è™•ç†å’Œå»é‡è¤‡ã€‚

## ä½¿ç”¨è·¯ç”±å™¨ä¸Šä¸‹æ–‡ (Using Router Context)

å‚³éçµ¦ `loader` å‡½æ•¸çš„ `context` åƒæ•¸æ˜¯ä¸€å€‹ç‰©ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹å…§å®¹çš„åˆä½µï¼š

- çˆ¶è·¯ç”±ä¸Šä¸‹æ–‡
- ç”± `beforeLoad` é¸é …æä¾›çš„æ­¤è·¯ç”±ä¸Šä¸‹æ–‡

å¾è·¯ç”±å™¨çš„é ‚éƒ¨é–‹å§‹ï¼Œæ‚¨å¯ä»¥é€é `context` é¸é …å°‡åˆå§‹ä¸Šä¸‹æ–‡å‚³éçµ¦è·¯ç”±å™¨ã€‚æ­¤ä¸Šä¸‹æ–‡å°‡å°è·¯ç”±å™¨ä¸­çš„æ‰€æœ‰è·¯ç”±å¯ç”¨ï¼Œä¸¦åœ¨æ¯å€‹è·¯ç”±åŒ¹é…æ™‚è¢«è¤‡è£½å’Œæ“´å±•ã€‚é€™æ˜¯é€é `beforeLoad` é¸é …å°‡ä¸Šä¸‹æ–‡å‚³éçµ¦è·¯ç”±ä¾†å¯¦ç¾çš„ã€‚æ­¤ä¸Šä¸‹æ–‡å°‡å°è©²è·¯ç”±çš„æ‰€æœ‰å­è·¯ç”±å¯ç”¨ã€‚æœ€çµ‚çš„ä¸Šä¸‹æ–‡å°‡å°è·¯ç”±çš„ `loader` å‡½æ•¸å¯ç”¨ã€‚

åœ¨é€™å€‹ç¯„ä¾‹ä¸­ï¼Œæˆ‘å€‘å°‡åœ¨è·¯ç”±ä¸Šä¸‹æ–‡ä¸­å»ºç«‹ä¸€å€‹å‡½æ•¸ä¾†ç²å–æ–‡ç« ï¼Œç„¶å¾Œåœ¨æˆ‘å€‘çš„ `loader` å‡½æ•¸ä¸­ä½¿ç”¨å®ƒã€‚

> ğŸ§  ä¸Šä¸‹æ–‡æ˜¯ä¾è³´æ³¨å…¥çš„å¼·å¤§å·¥å…·ã€‚æ‚¨å¯ä»¥ä½¿ç”¨å®ƒä¾†æ³¨å…¥æœå‹™ã€é‰¤å­å’Œå…¶ä»–ç‰©ä»¶åˆ°æ‚¨çš„è·¯ç”±å™¨å’Œè·¯ç”±ä¸­ã€‚æ‚¨é‚„å¯ä»¥ä½¿ç”¨è·¯ç”±çš„ `beforeLoad` é¸é …åœ¨æ¯å€‹è·¯ç”±ä¸Šéå¢åœ°å‚³éè³‡æ–™ã€‚

- `/utils/fetchPosts.tsx`

```tsx
export const fetchPosts = async () => {
  const res = await fetch(`/api/posts?page=${pageIndex}`)
  if (!res.ok) throw new Error('Failed to fetch posts')
  return res.json()
}
```

- `/routes/__root.tsx`

```tsx
import { createRootRouteWithContext } from '@tanstack/react-router'

// ä½¿ç”¨ createRootRouteWithContext<{...}>() å‡½æ•¸å»ºç«‹æ ¹è·¯ç”±ï¼Œä¸¦å‚³éæ‚¨å¸Œæœ›åœ¨è·¯ç”±å™¨ä¸Šä¸‹æ–‡ä¸­å¯ç”¨çš„ä»»ä½•é¡å‹ã€‚
export const Route = createRootRouteWithContext<{
  fetchPosts: typeof fetchPosts
}>()() // æ³¨æ„ï¼šé›™é‡èª¿ç”¨æ˜¯æœ‰æ„çš„ï¼Œå› ç‚º createRootRouteWithContext æ˜¯ä¸€å€‹å·¥å»  ;)
```

- `/routes/posts.tsx`

```tsx
import { createFileRoute } from '@tanstack/react-router'

// æ³¨æ„æˆ‘å€‘çš„ postsRoute å¦‚ä½•å¼•ç”¨ä¸Šä¸‹æ–‡ä¾†ç²å– fetchPosts å‡½æ•¸
// é€™å¯ä»¥æ˜¯ä¸€å€‹å¼·å¤§çš„å·¥å…·ï¼Œç”¨æ–¼åœ¨æ‚¨çš„è·¯ç”±å™¨å’Œè·¯ç”±ä¹‹é–“é€²è¡Œä¾è³´æ³¨å…¥ã€‚
export const Route = createFileRoute('/posts')({
  loader: ({ context: { fetchPosts } }) => fetchPosts(),
})
```

- `/router.tsx`

```tsx
import { routeTree } from './routeTree.gen'

// ä½¿ç”¨æ‚¨çš„ routerContext å»ºç«‹ä¸€å€‹æ–°çš„è·¯ç”±å™¨
// é€™å°‡è¦æ±‚æ‚¨æ»¿è¶³ routerContext çš„é¡å‹è¦æ±‚
const router = createRouter({
  routeTree,
  context: {
    // å°‡ fetchPosts å‡½æ•¸æä¾›çµ¦è·¯ç”±å™¨ä¸Šä¸‹æ–‡
    fetchPosts,
  },
})
```

## ä½¿ç”¨è·¯å¾‘åƒæ•¸ (Using Path Params)

è¦åœ¨ `loader` å‡½æ•¸ä¸­ä½¿ç”¨è·¯å¾‘åƒæ•¸ï¼Œè«‹é€éå‡½æ•¸åƒæ•¸çš„ `params` å±¬æ€§å­˜å–å®ƒå€‘ã€‚ä»¥ä¸‹æ˜¯ä¸€å€‹ç¯„ä¾‹ï¼š

```tsx
// routes/posts.$postId.tsx
export const Route = createFileRoute('/posts/$postId')({
  loader: ({ params: { postId } }) => fetchPostById(postId),
})
```

## ä½¿ç”¨è·¯ç”±ä¸Šä¸‹æ–‡ (Using Route Context)

å°‡å…¨å±€ä¸Šä¸‹æ–‡å‚³éçµ¦æ‚¨çš„è·¯ç”±å™¨å¾ˆå¥½ï¼Œä½†å¦‚æœæ‚¨æƒ³æä¾›ç‰¹å®šæ–¼è·¯ç”±çš„ä¸Šä¸‹æ–‡å‘¢ï¼Ÿé€™å°±æ˜¯ `beforeLoad` é¸é …çš„ç”¨æ­¦ä¹‹åœ°ã€‚`beforeLoad` é¸é …æ˜¯ä¸€å€‹å‡½æ•¸ï¼Œåœ¨å˜—è©¦è¼‰å…¥è·¯ç”±ä¹‹å‰é‹è¡Œï¼Œä¸¦æ¥æ”¶èˆ‡ `loader` ç›¸åŒçš„åƒæ•¸ã€‚é™¤äº†å…¶é‡å®šå‘æ½›åœ¨åŒ¹é…ã€é˜»æ­¢è¼‰å…¥å™¨è«‹æ±‚ç­‰èƒ½åŠ›å¤–ï¼Œå®ƒé‚„å¯ä»¥è¿”å›ä¸€å€‹ç‰©ä»¶ï¼Œè©²ç‰©ä»¶å°‡è¢«åˆä½µåˆ°è·¯ç”±çš„ä¸Šä¸‹æ–‡ä¸­ã€‚è®“æˆ‘å€‘çœ‹ä¸€å€‹ç¯„ä¾‹ï¼Œæˆ‘å€‘é€é `beforeLoad` é¸é …å°‡ä¸€äº›è³‡æ–™æ³¨å…¥åˆ°è·¯ç”±ä¸Šä¸‹æ–‡ä¸­ï¼š

```tsx
// /routes/posts.tsx
import { createFileRoute } from '@tanstack/react-router'

export const Route = createFileRoute('/posts')({
  // å°‡ fetchPosts å‡½æ•¸å‚³éçµ¦è·¯ç”±ä¸Šä¸‹æ–‡
```
